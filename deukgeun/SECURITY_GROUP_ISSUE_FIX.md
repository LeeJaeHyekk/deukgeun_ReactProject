# 보안 그룹 설정 문제 분석 및 해결

## 🔍 문제 상황

### 현재 보안 그룹 설정

**보안 그룹 ID**: `sg-0eb73ca53a176a4a8`

**인바운드 규칙:**
1. 포트 3000 (TCP) - 0.0.0.0/0 (모든 IP에서 접근 가능)
2. 포트 80 (HTTP) - 0.0.0.0/0 (모든 IP에서 접근 가능) ✅
3. 포트 5000 (TCP) - 0.0.0.0/0 (모든 IP에서 접근 가능) ❌ **문제**
4. 포트 22 (SSH) - 0.0.0.0/0 (모든 IP에서 접근 가능) ⚠️
5. 포트 443 (HTTPS) - 0.0.0.0/0 (모든 IP에서 접근 가능) ✅

### 발견된 문제

1. **포트 5000이 외부에 직접 노출됨**
   - 백엔드(포트 5000)가 외부에서 직접 접근 가능
   - ALB가 백엔드를 직접 타겟으로 할 수 있음
   - nginx를 거치지 않고 요청이 백엔드로 직접 전달됨

2. **보안 취약점**
   - 백엔드 API가 외부에 직접 노출됨
   - nginx의 보안 기능(rate limiting, DDoS 방어 등)을 우회할 수 있음
   - 인증/인가 로직을 우회할 수 있음

3. **정적 파일 요청 문제**
   - 외부 요청이 nginx를 거치지 않고 백엔드로 직접 전달됨
   - 백엔드는 정적 파일을 서빙하지 않으므로 404 오류 발생

## 📋 올바른 아키텍처

### 현재 아키텍처 (문제)

```
외부 요청 → ALB → EC2 (포트 5000) → 백엔드
              ↓
         EC2 (포트 80) → nginx (사용되지 않음)
```

### 올바른 아키텍처

```
외부 요청 → ALB → EC2 (포트 80) → nginx → EC2 (포트 5000) → 백엔드
                                 ↓
                            정적 파일 서빙
```

## ✅ 해결 방법

### 방법 1: 보안 그룹 수정 (권장)

**포트 5000 인바운드 규칙 수정:**

1. **현재 설정 제거:**
   - 포트 5000 (TCP) - 0.0.0.0/0 삭제

2. **새로운 설정 추가:**
   - 포트 5000 (TCP) - 소스: `sg-0eb73ca53a176a4a8` (같은 보안 그룹)
   - 또는 소스: `127.0.0.1/32` (로컬호스트만)
   - 또는 소스: `10.0.0.0/8` (VPC 내부 IP만)

**결과:**
- 포트 5000은 같은 EC2 인스턴스 내부에서만 접근 가능
- nginx(포트 80)만 외부에서 접근 가능
- 모든 요청이 nginx를 거쳐야 함

### 방법 2: ALB 타겟 그룹 확인

**AWS Console에서 확인:**

1. **ALB 타겟 그룹 설정:**
   - 타겟 그룹이 포트 80을 타겟으로 하는지 확인
   - 포트 5000을 타겟으로 하면 안 됨

2. **타겟 그룹 수정:**
   - 포트 80 (nginx)을 타겟으로 설정
   - 포트 5000 (백엔드)은 타겟에서 제외

### 방법 3: 보안 그룹 새로 생성 (권장)

**새 보안 그룹 생성:**

1. **외부 접근용 보안 그룹 (ALB용):**
   - 포트 80 (HTTP) - ALB 보안 그룹에서만 접근 가능
   - 포트 443 (HTTPS) - ALB 보안 그룹에서만 접근 가능

2. **내부 접근용 보안 그룹 (EC2용):**
   - 포트 5000 (TCP) - 같은 보안 그룹 내에서만 접근 가능
   - 포트 22 (SSH) - 관리자 IP에서만 접근 가능

3. **EC2 인스턴스에 두 보안 그룹 모두 적용**

## 🔧 AWS Console에서 수정 방법

### 보안 그룹 인바운드 규칙 수정

1. **EC2 Console → Security Groups**
2. **보안 그룹 선택**: `sg-0eb73ca53a176a4a8`
3. **Inbound rules 탭 클릭**
4. **포트 5000 규칙 편집 또는 삭제**
5. **새 규칙 추가:**
   - Type: Custom TCP
   - Port: 5000
   - Source: `sg-0eb73ca53a176a4a8` (같은 보안 그룹) 또는 `127.0.0.1/32`

### ALB 타겟 그룹 확인

1. **EC2 Console → Target Groups**
2. **ALB 타겟 그룹 선택**
3. **Health checks 탭 확인:**
   - Port: 80 (nginx)
   - Path: `/health` 또는 `/`
4. **Targets 탭 확인:**
   - Port: 80 (nginx)
   - Port: 5000이면 수정 필요

## 🧪 검증 방법

### 1. 포트 5000 외부 접근 차단 확인

```bash
# 외부에서 포트 5000 접근 테스트 (차단되어야 함)
curl -I http://$(curl -s ifconfig.me):5000/
# 예상: 연결 거부 또는 타임아웃

# 로컬에서 포트 5000 접근 테스트 (정상 작동해야 함)
curl -I http://localhost:5000/
# 예상: HTTP/1.1 200 OK
```

### 2. 포트 80 외부 접근 확인

```bash
# 외부에서 포트 80 접근 테스트 (정상 작동해야 함)
curl -I http://$(curl -s ifconfig.me)/
# 예상: HTTP/1.1 200 OK

# 정적 파일 요청 테스트
curl -I http://$(curl -s ifconfig.me)/js/vendor-BDnF4zds.js
# 예상: HTTP/1.1 200 OK, Content-Type: application/javascript
```

### 3. nginx 로그 확인

```bash
# nginx access 로그에서 정적 파일 요청 확인
sudo tail -f /var/log/nginx/access.log | grep "js/vendor"
# 예상: 정적 파일 요청이 nginx 로그에 나타남
```

### 4. PM2 로그 확인

```bash
# PM2 로그에서 정적 파일 요청이 보이지 않는지 확인
pm2 logs --lines 50 | grep "js/vendor"
# 예상: 정적 파일 요청이 백엔드 로그에 나타나지 않음
```

## ⚠️ 주의 사항

### 1. 보안 그룹 수정 전 확인

**중요:** 포트 5000을 외부에서 차단하면:
- ALB가 백엔드를 직접 타겟으로 하고 있다면 문제 발생
- ALB 타겟 그룹이 포트 80을 타겟으로 하는지 먼저 확인

### 2. 단계별 수정 권장

1. **1단계**: ALB 타겟 그룹이 포트 80을 타겟으로 하는지 확인
2. **2단계**: 확인 완료 후 보안 그룹 수정
3. **3단계**: 정적 파일 요청 테스트
4. **4단계**: PM2 로그에서 정적 파일 요청이 보이지 않는지 확인

### 3. SSH 포트 보안

**현재 설정:**
- 포트 22 (SSH) - 0.0.0.0/0 (모든 IP에서 접근 가능) ⚠️

**권장:**
- 포트 22 (SSH) - 관리자 IP 또는 VPN IP에서만 접근 가능하도록 제한

## 📝 요약

**문제:**
- 포트 5000이 외부에 직접 노출됨
- 외부 요청이 nginx를 거치지 않고 백엔드로 직접 전달됨
- 정적 파일 요청이 백엔드로 가서 404 오류 발생

**해결:**
1. 포트 5000 인바운드 규칙을 같은 보안 그룹 또는 로컬호스트로 제한
2. ALB 타겟 그룹이 포트 80을 타겟으로 하는지 확인
3. 모든 요청이 nginx를 거치도록 보장

**검증:**
- 외부에서 포트 5000 접근 차단 확인
- 외부에서 포트 80 접근 정상 확인
- 정적 파일 요청이 nginx를 통해 처리되는지 확인

